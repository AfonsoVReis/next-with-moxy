(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{122:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"rightToc",(function(){return o})),n.d(t,"default",(function(){return c}));var a=n(1),i=(n(0),n(139));const l={id:"recipe-staging-ci-cd-pipeline",title:"Staging CI/CD on GitLab and Google App Engine",sidebar_label:"Staging CI/CD Pipeline"},o=[{value:"Our Requirements",id:"our-requirements",children:[]},{value:"Walk-through",id:"walk-through",children:[{value:"1. Create the project in Google Cloud Platform",id:"1-create-the-project-in-google-cloud-platform",children:[]},{value:"2. Create the application in Google App Engine",id:"2-create-the-application-in-google-app-engine",children:[]},{value:"3. Enable Cloud Build API",id:"3-enable-cloud-build-api",children:[]},{value:"4. Enable App Engine Admin API",id:"4-enable-app-engine-admin-api",children:[]},{value:"5. Create an account for GitLab",id:"5-create-an-account-for-gitlab",children:[]},{value:"6. Add <code>.gitlab-ci.yml</code>",id:"6-add-gitlab-ciyml",children:[]},{value:"7. Add <code>.gcloudignore</code>",id:"7-add-gcloudignore",children:[]},{value:"8. Setup CI/CD environment variables",id:"8-setup-cicd-environment-variables",children:[]},{value:"9. Test it out!",id:"9-test-it-out",children:[]}]},{value:"Integration Screenshots",id:"integration-screenshots",children:[]}],r={rightToc:o},b="wrapper";function c({components:e,...t}){return Object(i.b)(b,Object(a.a)({},r,t,{components:e,mdxType:"MDXLayout"}),Object(i.b)("img",{src:"images/gitlab-gae.png",width:"400"}),Object(i.b)("p",null,"In this recipe, you will be guided through the process of creating a CI/CD pipeline on GitLab that tests, builds and deploys ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/moxystudio/next-with-moxy"}),"next-with-moxy")," based projects on ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.google.com/appengine/"}),"Google App Engine")," into a staging environment."),Object(i.b)("h2",{id:"our-requirements"},"Our Requirements"),Object(i.b)("p",null,"A few strict requirements were set for our CI/CD pipeline:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Be easy to setup and maintain."),Object(i.b)("li",{parentName:"ol"},"Be cost effective."),Object(i.b)("li",{parentName:"ol"},"Have an environment as similar as possible to the production environment."),Object(i.b)("li",{parentName:"ol"},"Have a staging environment accessible publicly via a URL, like ",Object(i.b)("inlineCode",{parentName:"li"},"https://some-domain.com"),", continuously deployed of master branch."),Object(i.b)("li",{parentName:"ol"},"Have a environment for each release accessible publicly via a URL ",Object(i.b)("inlineCode",{parentName:"li"},"https://v1-4-5.some-domain.com"),", continuously deployed of release tags."),Object(i.b)("li",{parentName:"ol"},"Have a preview environment for every merge request accessible via publicly a URL like ",Object(i.b)("inlineCode",{parentName:"li"},"https://feat-homepage-hero.some-domain.com"),", continuously deployed of the branch associated with the merge request."),Object(i.b)("li",{parentName:"ol"},"Have HTTPS enabled for all URLs.")),Object(i.b)("p",null,"We have successfully used ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://zeit.co/now"}),"Zeit's Now")," in the past and it ticked all the above requirements. But with the ",Object(i.b)("inlineCode",{parentName:"p"},"v2")," release, Now enforces serverless lambda deployments which are different from regular deployments that use the ",Object(i.b)("inlineCode",{parentName:"p"},"npm start")," command. This effectively broke point ",Object(i.b)("inlineCode",{parentName:"p"},"3")," of our requirements list."),Object(i.b)("p",null,"After analyzing ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://render.com"}),"a")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.heroku.com/"}),"lot")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.microsoft.com/en-us/azure/app-service"}),"of")," ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://aws.amazon.com/elasticbeanstalk/"}),"alternatives")," from various providers against our requirements, we settled on using ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.google.com/appengine/"}),"Google App Engine")," from Google Cloud Platform."),Object(i.b)("h2",{id:"walk-through"},"Walk-through"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"The steps below can only be completed by Tech Leads due to permissions.")),Object(i.b)("h3",{id:"1-create-the-project-in-google-cloud-platform"},"1. Create the project in Google Cloud Platform"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Login into ",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"https://console.cloud.google.com"}),"Google Cloud Console")," using your MOXY's email."),Object(i.b)("li",{parentName:"ol"},"Create a new project by clicking in the header's dropdown and select ",Object(i.b)("inlineCode",{parentName:"li"},"New project"),"."),Object(i.b)("li",{parentName:"ol"},"Fill in the ",Object(i.b)("inlineCode",{parentName:"li"},"Project Name")," and ",Object(i.b)("inlineCode",{parentName:"li"},"Project ID")," fields by using the following convention:\n3.1. ",Object(i.b)("inlineCode",{parentName:"li"},"Project Name")," must be equal to the GitLab group name, like ",Object(i.b)("inlineCode",{parentName:"li"},"acme"),".\n3.1. ",Object(i.b)("inlineCode",{parentName:"li"},"Project ID ")," should be equal to the ",Object(i.b)("inlineCode",{parentName:"li"},"Project Name")," but suffixed with ",Object(i.b)("inlineCode",{parentName:"li"},"-with-moxy"),", like ",Object(i.b)("inlineCode",{parentName:"li"},"acme-with-moxy"),". Since the ",Object(i.b)("inlineCode",{parentName:"li"},"Project ID")," will determine the your application URLs, you may use an abbreviation of the ",Object(i.b)("inlineCode",{parentName:"li"},"Project Name")," when composing the ",Object(i.b)("inlineCode",{parentName:"li"},"Project ID")," if it's too large."),Object(i.b)("li",{parentName:"ol"},"Once created, select the recently created project in the header dropdown.")),Object(i.b)("h3",{id:"2-create-the-application-in-google-app-engine"},"2. Create the application in Google App Engine"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Click in ",Object(i.b)("inlineCode",{parentName:"li"},"App Engine")," menu item on the left sidebar and then hit ",Object(i.b)("inlineCode",{parentName:"li"},"Create Application"),"."),Object(i.b)("li",{parentName:"ol"},"Choose ",Object(i.b)("inlineCode",{parentName:"li"},"europe-west")," as the region."),Object(i.b)("li",{parentName:"ol"},"Choose ",Object(i.b)("inlineCode",{parentName:"li"},"NodeJS")," as the language and ",Object(i.b)("inlineCode",{parentName:"li"},"Standard")," as the environment."),Object(i.b)("li",{parentName:"ol"},"Wait until the application is created."),Object(i.b)("li",{parentName:"ol"},"Once done, you may skip the wizard's next steps (I'll do this later).")),Object(i.b)("h3",{id:"3-enable-cloud-build-api"},"3. Enable Cloud Build API"),Object(i.b)("p",null,"For GitLab to be able to interact with App Engine, we must enable ",Object(i.b)("inlineCode",{parentName:"p"},"App Engine Admin API"),":"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Click in ",Object(i.b)("inlineCode",{parentName:"li"},"API & Services > Library")," menu item on the left sidebar."),Object(i.b)("li",{parentName:"ol"},"Search for ",Object(i.b)("inlineCode",{parentName:"li"},"Cloud Build API")," and then click ",Object(i.b)("inlineCode",{parentName:"li"},"Enable"),".")),Object(i.b)("h3",{id:"4-enable-app-engine-admin-api"},"4. Enable App Engine Admin API"),Object(i.b)("p",null,"For GitLab to be able to interact with App Engine, we must enable ",Object(i.b)("inlineCode",{parentName:"p"},"App Engine Admin API"),":"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Click in ",Object(i.b)("inlineCode",{parentName:"li"},"API & Services > Library")," menu item on the left sidebar."),Object(i.b)("li",{parentName:"ol"},"Search for ",Object(i.b)("inlineCode",{parentName:"li"},"App Engine Admin API")," and then click ",Object(i.b)("inlineCode",{parentName:"li"},"Enable"),".")),Object(i.b)("h3",{id:"5-create-an-account-for-gitlab"},"5. Create an account for GitLab"),Object(i.b)("p",null,"Now that we enabled ",Object(i.b)("inlineCode",{parentName:"p"},"App Engine Admin API"),", we must create an account for GitLab to be able to interact with it:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Click in ",Object(i.b)("inlineCode",{parentName:"li"},"IAM & Admin > Service accounts")," menu item on the left sidebar and then hit ",Object(i.b)("inlineCode",{parentName:"li"},"Create Service Account")," on the top."),Object(i.b)("li",{parentName:"ol"},"Type ",Object(i.b)("inlineCode",{parentName:"li"},"gitlab-ci")," in the ",Object(i.b)("inlineCode",{parentName:"li"},"Service Account Name")," and hit ",Object(i.b)("inlineCode",{parentName:"li"},"Create"),"."),Object(i.b)("li",{parentName:"ol"},"Add ",Object(i.b)("inlineCode",{parentName:"li"},"App Engine Deployer"),", ",Object(i.b)("inlineCode",{parentName:"li"},"App Engine Service Admin"),", ",Object(i.b)("inlineCode",{parentName:"li"},"Cloud Build Editor"),", ",Object(i.b)("inlineCode",{parentName:"li"},"Storage Admin")," roles and hit ",Object(i.b)("inlineCode",{parentName:"li"},"Continue"),"."),Object(i.b)("li",{parentName:"ol"},"Click in the ",Object(i.b)("inlineCode",{parentName:"li"},"Create Key")," button, choose ",Object(i.b)("inlineCode",{parentName:"li"},"JSON")," and hit ",Object(i.b)("inlineCode",{parentName:"li"},"Create"),". The key should have been downloaded to your computer.")),Object(i.b)("h3",{id:"6-add-gitlab-ciyml"},"6. Add ",Object(i.b)("inlineCode",{parentName:"h3"},".gitlab-ci.yml")),Object(i.b)("p",null,"Copy ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"code/_gitlab-ci.yml"}),Object(i.b)("inlineCode",{parentName:"a"},".gitlab-ci.yml"))," into the root folder of your project. You may take a look at it to understand the different stages and jobs."),Object(i.b)("h3",{id:"7-add-gcloudignore"},"7. Add ",Object(i.b)("inlineCode",{parentName:"h3"},".gcloudignore")),Object(i.b)("p",null,"Copy ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"code/_gcloudignore"}),Object(i.b)("inlineCode",{parentName:"a"},".gcloudignore"))," into the root folder of your project. This file contains a ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.google.com/sdk/gcloud/reference/topic/gcloudignore"}),"blacklist of patterns")," that will match files that will not be uplodated to App Engine."),Object(i.b)("h3",{id:"8-setup-cicd-environment-variables"},"8. Setup CI/CD environment variables"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},".gitlab-ci.yml")," file references some environment variables that you must provide."),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"On the GitLab repository page, click ",Object(i.b)("inlineCode",{parentName:"p"},"Settings -> CI/CD"),".")),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"Expand the ",Object(i.b)("inlineCode",{parentName:"p"},"Variables")," section and fill the following variables:"),Object(i.b)("blockquote",{parentName:"li"},Object(i.b)("p",{parentName:"blockquote"},"\u2139\ufe0f Note that you will need to have a duplicate entry for each variable, one per scope")),Object(i.b)("table",{parentName:"li"},Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Name"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Value"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Scope"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"GAE_PROJECT_ID")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ID of the project you created in Google Cloud Platform"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"staging")," & ",Object(i.b)("inlineCode",{parentName:"td"},"preview/*"))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"GAE_KEY")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The contents of the key file you downloaded in step ",Object(i.b)("inlineCode",{parentName:"td"},"4.")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"staging")," & ",Object(i.b)("inlineCode",{parentName:"td"},"preview/*"))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"GAE_APP_YML")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"See ",Object(i.b)("inlineCode",{parentName:"td"},"app.yml")," below"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"staging")," & ",Object(i.b)("inlineCode",{parentName:"td"},"preview/*"))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"COMPRESSION")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"0")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"staging")," & ",Object(i.b)("inlineCode",{parentName:"td"},"preview/*"))))),Object(i.b)("p",{parentName:"li"},"Contents of ",Object(i.b)("inlineCode",{parentName:"p"},"app.yml"),":"),Object(i.b)("pre",{parentName:"li"},Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yml"}),"runtime: nodejs12\nenv: standard\ninstance_class: B1\nbasic_scaling:\n  max_instances: 1\n  idle_timeout: 5m\nhandlers:\n- url: /.*\n  secure: always\n  redirect_http_response_code: 301\n  script: auto\n")),Object(i.b)("p",{parentName:"li"},"The app settings above makes sure that we are cost effective by using the cheapest instance class and by having a maximum of 1 instances running at all times. Moreover, that instance will automatically dispose after 5 minutes of idle time, and will spawn again on a new request, taking a maximum of 10 secs to wake up. Please note that we are only charged during the time the instance is up and not while it's disposed! \ud83d\udc4c"),Object(i.b)("p",{parentName:"li"},"Here's a screenshot of how the variables should look like:"),Object(i.b)("p",{parentName:"li"},Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"images/screenshot-variables.png",alt:"CI/CD Variables",title:"CI/CD Variables"})))),Object(i.b)("li",{parentName:"ol"},Object(i.b)("p",{parentName:"li"},"\u2757Delete the key file from your computer (don't forget to remove it from the trash too)."))),Object(i.b)("h3",{id:"9-test-it-out"},"9. Test it out!"),Object(i.b)("p",null,"You may now commit ",Object(i.b)("inlineCode",{parentName:"p"},".gitlab-ci.yml")," into a new branch, push it and open a merge request to test things out. Be sure to also check if the preview environment was successfully un-deployed when the merge request got merged."),Object(i.b)("h2",{id:"integration-screenshots"},"Integration Screenshots"),Object(i.b)("p",null,"This is how the integration looks like:"),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Pipeline Overview")),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"images/screenshot-pipeline.png",alt:"Pipeline Overview",title:"Pipeline Overview"}))),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},'Merge Request with "View app"')),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"images/screenshot-merge-request.png",alt:"Merge Request",title:"Merge Request"}))),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Instance automatically created in App Engine with the branch name as the version")),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"images/screenshot-gcp.png",alt:"GCP",title:"GCP"}))),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"Automatically undo  the deployment when the Merge Request is merged")),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"images/screenshot-undeploy.png",alt:"Un-deploy",title:"Un-deploy"}))))}c.isMDXComponent=!0},139:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return d}));var a=n(0),i=n.n(a),l=i.a.createContext({}),o=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):Object.assign({},t,e)),n},r=function(e){var t=o(e.components);return i.a.createElement(l.Provider,{value:t},e.children)};var b="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},p=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,r=e.parentName,b=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&-1===t.indexOf(a)&&(n[a]=e[a]);return n}(e,["components","mdxType","originalType","parentName"]),p=o(n),d=a,m=p[r+"."+d]||p[d]||c[d]||l;return n?i.a.createElement(m,Object.assign({},{ref:t},b,{components:n})):i.a.createElement(m,Object.assign({},{ref:t},b))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=p;var r={};for(var c in t)hasOwnProperty.call(t,c)&&(r[c]=t[c]);r.originalType=e,r[b]="string"==typeof e?e:a,o[1]=r;for(var d=2;d<l;d++)o[d]=n[d];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);